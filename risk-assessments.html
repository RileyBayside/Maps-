<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Risk Assessments</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a; --ink-2:#111827; --muted:#e5e7eb; --bg:#f6f7fb; --card:#ffffff;
      --accent:#d11e2b; --accent-600:#b71a24;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
    }

    /* Header */
    .bar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 16px; border-bottom:1px solid var(--muted); background:#fff; position:sticky; top:0; z-index:10;
    }
    .brand{ display:flex; align-items:center; gap:10px }
    .brand img{ height:40px; display:block }
    .brand .title{ font-size:18px; font-weight:800 }

    .back{ border:0; border-radius:10px; padding:8px 12px; font-weight:800; color:#fff; background:#111827; text-decoration:none }
    .back:hover{ background:#1f2937 }

    .container{ max-width:1120px; margin:18px auto 40px; padding:0 16px }

    .panel{
      background:#fff; border:1px solid var(--muted); border-radius:16px;
      box-shadow:0 8px 26px rgba(16,24,40,.08); padding:12px;
    }
    .filters{ display:grid; grid-template-columns: 220px 220px 1fr auto auto; gap:10px; align-items:center }
    .filters .field{ display:flex; flex-direction:column; gap:6px }
    .filters input{
      height:38px; padding:0 10px; border:1px solid #e2e8f0; border-radius:10px; font:inherit;
    }
    .btn{ border:0; border-radius:10px; padding:9px 12px; font-weight:800; color:#fff; background:#111827; cursor:pointer }
    .btn:hover{ background:#1f2937 }
    .btn-red{ background:var(--accent) } .btn-red:hover{ background:var(--accent-600) }

    .card{ background:#fff; border:1px solid var(--muted); border-radius:16px; box-shadow:0 8px 26px rgba(16,24,40,.08); }
    .card h4{ margin:10px 12px; font-size:14px; font-weight:800; color:#334155 }
    .card .body{ padding:0 8px 10px }

    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{
      text-align:left; font-size:13px; color:#111827; background:#f8fafc; border-bottom:1px solid #e2e8f0;
      padding:10px 12px; position:sticky; top:0; z-index:5;
    }
    tbody td{ padding:10px 12px; border-bottom:1px solid #eef2f7; font-size:13px; color:#334155; vertical-align:top; }
    tbody tr:hover{ background:#fbfdff }
    .nowrap{ white-space:nowrap }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js" defer></script>
  <script src="firebase-init.js" defer></script>
  <script src="auth-guard.js" defer></script>

  <!-- PDF libs -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js" defer></script>
</head>
<body>
  <header class="bar">
    <div class="brand">
      <img src="logo.png" alt="Bayside" / loading="lazy" decoding="async">
      <div class="title">Risk Assessments</div>
    </div>
    <a class="back" href="admin.html">Back to Dashboard</a>
  </header>

  <main class="container">
    <!-- Filters -->
    <section class="panel" style="margin-bottom:12px">
      <div class="filters">
        <label class="field">
          <span style="font-size:12px;color:#64748b">Start date</span>
          <input id="startDate" type="date">
        </label>
        <label class="field">
          <span style="font-size:12px;color:#64748b">End date</span>
          <input id="endDate" type="date">
        </label>
        <label class="field">
          <span style="font-size:12px;color:#64748b">Operator (name or email)</span>
          <input id="opFilter" placeholder="e.g., Alan or alan@…">
        </label>
        <button id="applyBtn" class="btn">Apply</button>
        <button id="exportBtn" class="btn btn-red">Export to PDF</button>
      </div>
    </section>

    <!-- Results -->
    <section class="card">
      <h4>— results</h4>
      <div class="body" style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th class="nowrap">Date</th>
              <th>Operator</th>
              <th class="nowrap">PPE</th>
              <th class="nowrap">Equip</th>
              <th>Hazards</th>
              <th>Traffic</th>
              <th>Weather</th>
              <th>SWMS</th>
              <th>Fitness</th>
              <th class="nowrap">Stop-Work</th>
              <th>Typed Name / Notes</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>
  </main>
  
<script>
(function(){
  const db = firebase.firestore();

  // --- dom helpers ---
  const $ = (id) => document.getElementById(id);
  const rowsEl = $('rows');

  // ===== AEST (Australia/Brisbane) helpers =====
  const AEST_TZ = 'Australia/Brisbane'; // UTC+10, no DST

  // yyyy-mm-dd string for "today" in AEST (perfect for <input type="date">)
  function aestTodayStr(){
    return new Intl.DateTimeFormat('en-CA', { timeZone: AEST_TZ }).format(new Date());
  }
  // shift a yyyy-mm-dd (AEST) by N days and return a new yyyy-mm-dd (AEST)
  function shiftAestDayStr(dayStr, delta){
    const [y,m,d] = dayStr.split('-').map(Number);
    const dt = new Date(Date.UTC(y, m-1, d + delta, 0,0,0,0));
    return new Intl.DateTimeFormat('en-CA', { timeZone: AEST_TZ }).format(dt);
  }
  // For Firestore query bounds: convert an AEST date (yyyy-mm-dd) to the UTC instant
  // that corresponds to AEST midnight at start/end of that day.
  function startUtcForAestDay(dayStr){ const [y,m,d] = dayStr.split('-').map(Number);
    return new Date(Date.UTC(y, m-1, d, 14, 0, 0, 0)); } // AEST 00:00 == 14:00 UTC prev day
  function endUtcForAestDay(dayStr){ const [y,m,d] = dayStr.split('-').map(Number);
    return new Date(Date.UTC(y, m-1, d+1, 14, 0, 0, 0)); }

  // UI defaults: last 7 AEST days ending AEST "today"
  function setDefaultDates(){
    const today = aestTodayStr();
    $('endDate').value   = today;
    $('startDate').value = shiftAestDayStr(today, -7);
  }

  const yesNo = (v) => (typeof v === 'boolean' ? (v ? 'Yes' : 'No') : (String(v||'').trim() || '—'));

  // Flexible schema mapper (supports {answers:{...}} or flat)
  function flatten(rec){
    const A = rec.answers || rec;
    const out = {
      ppe:        A.ppe ?? A.ppeOk ?? A.ppeChecked ?? null,
      equipment:  A.equipment ?? A.equipmentOk ?? null,
      hazards:    A.hazards ?? A.hazardsChecked ?? null,
      traffic:    A.traffic ?? A.trafficMgmt ?? null,
      weather:    A.weather ?? A.weatherOk ?? null,
      swms:       A.swms ?? A.swmsOk ?? null,
      fitness:    A.fitness ?? A.fitForWork ?? null,
      stopWork:   A.stopWork ?? A.stop_work ?? null,
      typedName:  A.typedName ?? A.nameTyped ?? '',
      notes:      A.notes ?? A.otherNotes ?? '',
    };
    const operator = rec.operatorDisplay || rec.operatorName || rec.userName || rec.operator || rec.name || '';
    const email    = rec.operatorEmail || rec.email || '';
    return { ...out, operator, email };
  }

  // ===== listeners & rendering =====
  let unsubs = [];
  let cache = new Map(); // key -> { data, created }
  let lastDocs = [];     // for export: [{created, flat}]
  let totalListeners = 0;
  let errorCount = 0;
  let gotAnySnapshot = false;

  function stopListeners(){
    unsubs.forEach(u => { try{ u(); }catch(_){} });
    unsubs = [];
    cache.clear();
    totalListeners = 0;
    errorCount = 0;
    gotAnySnapshot = false;
    rowsEl.innerHTML = `<tr><td colspan="11" style="color:#64748b">Loading…</td></tr>`;
  }

  function onSnap(prefix, snap){
    gotAnySnapshot = true;
    snap.docChanges().forEach(ch=>{
      const k = `${prefix}/${ch.doc.id}`;
      if (ch.type === 'removed'){ cache.delete(k); return; }
      const d = ch.doc.data() || {};
      const created = d.createdAt?.toDate ? d.createdAt.toDate() :
                      (d.createdAt instanceof Date ? d.createdAt : null);
      cache.set(k, { data:d, created });
    });
    renderMerged();
  }

  function onErr(collectionName, err){
    console.warn(`${collectionName} query failed:`, err);
    errorCount++;
    // If all listeners errored and nothing ever arrived, show a real failure
    if (errorCount >= totalListeners && !gotAnySnapshot){
      rowsEl.innerHTML = `<tr><td colspan="11" style="color:#b91c1c;font-weight:700">Failed to load results.</td></tr>`;
    }
  }

  function renderMerged(){
    const q = ($('opFilter').value || '').trim().toLowerCase();
    const records = Array.from(cache.values())
      .map(({data, created}) => ({ created, flat: flatten(data) }))
      .filter(r => {
        if (!q) return true;
        const s = [r.flat.operator, r.flat.email].filter(Boolean).join(' · ').toLowerCase();
        return s.includes(q);
      })
      .sort((a,b) => (b.created?.getTime()||0) - (a.created?.getTime()||0));

    lastDocs = records.map(x => ({ created: x.created || null, flat: x.flat }));

    if (!records.length){
      rowsEl.innerHTML = `<tr><td colspan="11" style="color:#64748b">No results for this range.</td></tr>`;
      return;
    }

    const frag = document.createDocumentFragment();
    records.forEach(({created, flat})=>{
      const dateStr = created
        ? new Intl.DateTimeFormat('en-AU',{ timeZone:AEST_TZ, day:'2-digit', month:'2-digit', year:'numeric'}).format(created)
        : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="nowrap">${dateStr}</td>
        <td>${[flat.operator, flat.email].filter(Boolean).join(' · ') || '—'}</td>
        <td>${yesNo(flat.ppe)}</td>
        <td>${yesNo(flat.equipment)}</td>
        <td>${yesNo(flat.hazards)}</td>
        <td>${yesNo(flat.traffic)}</td>
        <td>${yesNo(flat.weather)}</td>
        <td>${yesNo(flat.swms)}</td>
        <td>${yesNo(flat.fitness)}</td>
        <td>${yesNo(flat.stopWork)}</td>
        <td>${[flat.typedName, (flat.notes||'').trim()].filter(Boolean).join(' — ') || '—'}</td>
      `;
      frag.appendChild(tr);
    });
    rowsEl.innerHTML = '';
    rowsEl.appendChild(frag);
  }

  async function apply(){
    stopListeners();

    // Use AEST-aligned date strings from the inputs (defaulted to AEST today/-7)
    const startStr = $('startDate').value || aestTodayStr();
    const endStr   = $('endDate').value   || aestTodayStr();
    const startUtc = startUtcForAestDay(startStr);
    const endUtc   = endUtcForAestDay(endStr);

    // Start both listeners; show results as soon as either responds
    totalListeners = 2;

    try{
      const u1 = db.collection('risk_assessments')
        .where('createdAt','>=', startUtc)
        .where('createdAt','<',  endUtc)
        .orderBy('createdAt','desc')
        .onSnapshot(s => onSnap('risk_assessments', s), e => onErr('risk_assessments', e));
      unsubs.push(u1);
    }catch(e){ onErr('risk_assessments', e); }

    try{
      const u2 = db.collection('riskAssessments')
        .where('createdAt','>=', startUtc)
        .where('createdAt','<',  endUtc)
        .orderBy('createdAt','desc')
        .onSnapshot(s => onSnap('riskAssessments', s), e => onErr('riskAssessments', e));
      unsubs.push(u2);
    }catch(e){ onErr('riskAssessments', e); }
  }

  // ======== PDF export ========
  async function exportPDF(){
    if (!lastDocs.length){ alert('Nothing to export for the current filter.'); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'landscape', unit:'mm', format:'a4' });
    const pageW = doc.internal.pageSize.getWidth();
    const margin = 14;
    let y = margin;

    // Header with logo + title
    try{
      const img = await loadImage('logo.png');
      const logoH = 12; // mm
      const ratio = img.naturalWidth ? (img.naturalHeight / img.naturalWidth) : (1/3);
      const logoW = logoH / ratio;
      doc.addImage(img, 'PNG', margin, y, logoW, logoH);
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      doc.text('Risk Assessments', margin + logoW + 6, y + 8);
      y += logoH + 3;
    }catch(_){
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      doc.text('Risk Assessments', margin, y + 6); y += 12;
    }

    // Filters line
    const startStr = $('startDate').value || aestTodayStr();
    const endStr   = $('endDate').value   || aestTodayStr();
    const opStr    = ($('opFilter').value || '').trim();
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    const filt = `Dates: ${startStr} → ${endStr}` + (opStr ? `   •   Operator filter: ${opStr}` : '');
    doc.text(filt, margin, y); y += 4;

    // Build rows for the table
    const header = ['Date','Operator','Email','PPE','Equipment','Hazards','Traffic','Weather','SWMS','Fitness','Stop-Work','Typed Name','Notes'];
    const body = lastDocs.map(({created, flat})=>{
      const dateStr = created
        ? new Intl.DateTimeFormat('en-AU',{ timeZone:AEST_TZ, day:'2-digit', month:'2-digit', year:'numeric'}).format(created)
        : '';
      return [
        dateStr,
        flat.operator || '',
        flat.email || '',
        yesNo(flat.ppe),
        yesNo(flat.equipment),
        yesNo(flat.hazards),
        yesNo(flat.traffic),
        yesNo(flat.weather),
        yesNo(flat.swms),
        yesNo(flat.fitness),
        yesNo(flat.stopWork),
        flat.typedName || '',
        (flat.notes || '').replace(/\r?\n/g,' / ')
      ];
    });

    doc.autoTable({
      head:[header],
      body,
      startY: y + 2,
      margin: { left: margin, right: margin },
      styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak', valign: 'top' },
      headStyles: { fillColor: [248,250,252], textColor: 17, lineWidth: 0.2, lineColor: [226,232,240] },
      bodyStyles: { lineWidth: 0.2, lineColor: [238,242,247] }
    });

    // Footer with page numbers & generated time (AEST)
    const pages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pages; i++){
      doc.setPage(i);
      const h = doc.internal.pageSize.getHeight();
      doc.setFontSize(8);
      const gen = new Intl.DateTimeFormat('en-AU', {
        timeZone: AEST_TZ, year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit'
      }).format(new Date());
      doc.text(`Generated ${gen} AEST`, margin, h - 6);
      doc.text(`Page ${i} of ${pages}`, pageW - margin, h - 6, { align:'right' });
    }

    doc.save('risk-assessments.pdf');
  }

  function loadImage(src){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = src;
    });
  }

  // Wire up UI
  $('applyBtn').addEventListener('click', apply);
  $('exportBtn').addEventListener('click', exportPDF);

  // Role gate: only admins/managers can see global results; start listeners after that.
  setDefaultDates();
  firebase.auth().onAuthStateChanged(async (u) => {
    if (!u) { location.href = 'login.html'; return; }
    try {
      const snap = await db.collection('users').doc(u.uid).get();
      const role = snap.data()?.role || '';
      if (!['admin','manager'].includes(role)) {
        rowsEl.innerHTML = `<tr><td colspan="11" style="color:#b91c1c;font-weight:700">
          You don’t have access to view risk assessments.
        </td></tr>`;
        return;
      }
      apply();
    } catch (e) {
      console.warn('role check failed', e);
      // Fallback: still try to apply, errors will show properly now
      apply();
    }
  });
})();
</script>

</body>
</html>
